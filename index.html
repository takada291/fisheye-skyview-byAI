<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIé­šçœ¼</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="apple-touch-icon" href="icon-fish.png">
    
    <meta name="theme-color" content="#2c3e50">

    <style>
        body {
            font-family: sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f4f8; color: #333; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .app-title { font-size: 2rem; color: #2980b9; margin-bottom: 20px; font-weight: bold; }
        .app-desc { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 40px; text-align: center; }
        .mode-btn {
            width: 250px; padding: 20px; margin: 10px;
            font-size: 1.2rem; font-weight: bold;
            border: none; border-radius: 15px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .mode-btn:active { transform: scale(0.95); }
        .btn-camera { background-color: #2980b9; color: white; }
        .btn-file { background-color: #8e44ad; color: white; }

        /* --- è§£æãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        #analysisScreen {
            display: none; flex-direction: column; height: 100%;
            background-color: #2c3e50;
        }
        
        /* ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .canvas-container {
            flex: 1; position: relative;
            background: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { max-width: 100%; max-height: 100%; }

        /* å††åˆã‚ã›ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #circleOverlay {
            position: absolute;
            border: 2px solid rgba(231, 76, 60, 0.8); /* èµ¤æ  */
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* æ å¤–ã‚’æš—ã */
            pointer-events: none;
            display: none; /* èª¿æ•´ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º */
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .controls-panel {
            background: #fff; color: #333;
            padding: 15px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            max-height: 50vh; overflow-y: auto;
        }

        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            font-weight: bold; color: #7f8c8d; border-bottom: 3px solid transparent;
        }
        .tab.active { color: #2980b9; border-bottom-color: #2980b9; }

        .control-group { display: none; }
        .control-group.active { display: block; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .slider-row { display: flex; align-items: center; margin-bottom: 10px; }
        .slider-label { width: 70px; font-size: 0.8rem; font-weight: bold; }
        input[type=range] { flex: 1; }

        /* çµæœè¡¨ç¤º */
        .result-box {
            background: #ecf0f1; padding: 15px; border-radius: 10px;
            margin-top: 15px; display: flex; justify-content: space-around;
        }
        .res-item { text-align: center; }
        .res-val { font-size: 1.8rem; font-weight: bold; color: #2980b9; }
        .res-label { font-size: 0.8rem; color: #7f8c8d; }

        .action-btns { display: flex; justify-content: space-between; margin-top: 15px; }
        .sm-btn { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-back { background: #95a5a6; color: white; }
        .btn-recalc { background: #27ae60; color: white; }

        /* éš ã—è¦ç´  */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="app-title">ğŸŸ AIé­šçœ¼ v1.1</div>
        <div class="app-desc">å…¨å¤©ç©ºå†™çœŸ è§£æãƒ„ãƒ¼ãƒ«<br>ï¼ˆé–‹ç©ºåº¦ãƒ»å…‰ç’°å¢ƒè©•ä¾¡ï¼‰</div>
        
        <button class="mode-btn btn-camera" onclick="startCamera()">
            <span>ğŸ“·</span> ã‚«ãƒ¡ãƒ©ã§æ’®å½±
        </button>
        <button class="mode-btn btn-file" onclick="document.getElementById('fileInput').click()">
            <span>ğŸ“‚</span> å†™çœŸã‚’é¸æŠ
        </button>
        <div style="margin-top:20px; font-size:0.8rem; color:#999;">
            ãƒ¬ãƒ³ã‚ºå–ã‚Šä»˜ã‘ä½ç½®ã®èª¿æ•´æ©Ÿèƒ½ä»˜ã<br>
            â€»ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã”åˆ©ç”¨ãã ã•ã„
        </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*">

    <div id="analysisScreen">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div id="circleOverlay"></div>
        </div>

        <div class="controls-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('lens')">â‘  ãƒ¬ãƒ³ã‚ºåˆã‚ã›</div>
                <div class="tab" onclick="switchTab('analysis')">â‘¡ è§£æãƒ»çµæœ</div>
            </div>

            <div id="tab-lens" class="control-group active">
                <p style="font-size:0.8rem; margin-bottom:10px;">èµ¤æ ã‚’é­šçœ¼ãƒ¬ãƒ³ã‚ºã®ä¸¸ã„å†™çœŸã«åˆã‚ã›ã¦ãã ã•ã„</p>
                
                <div class="slider-row">
                    <span class="slider-label">ã‚µã‚¤ã‚º</span>
                    <input type="range" id="sizeSlider" min="10" max="100" value="80">
                </div>
                <div class="slider-row">
                    <span class="slider-label">å·¦å³ X</span>
                    <input type="range" id="xSlider" min="0" max="100" value="50">
                </div>
                <div class="slider-row">
                    <span class="slider-label">ä¸Šä¸‹ Y</span>
                    <input type="range" id="ySlider" min="0" max="100" value="50">
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="sm-btn btn-recalc" onclick="switchTab('analysis')">æ¬¡ã¸ï¼ˆè§£æï¼‰</button>
                </div>
            </div>

            <div id="tab-analysis" class="control-group">
                <div class="slider-row">
                    <span class="slider-label">æ˜ã‚‹ã•</span>
                    <input type="range" id="threshSlider" min="0" max="255" value="180" oninput="processImage()">
                </div>
                <div style="font-size:0.7rem; color:#e74c3c; text-align:right;">â€»èµ¤è‰²ï¼ç©º</div>

                <div class="result-box">
                    <div class="res-item">
                        <div class="res-label">é–‹ç©ºåº¦ (SVF)</div>
                        <div class="res-val" id="valSVF">-</div>
                    </div>
                    <div class="res-item">
                        <div class="res-label">å˜ç´”ç©ºéš™ç‡</div>
                        <div class="res-val" id="valOpen">-</div>
                    </div>
                </div>
                <div style="font-size:0.7rem; color:#7f8c8d; margin-top:5px; text-align:center;">
                    â€»SVF: å¤©é ‚ä»˜è¿‘ã®é‡ã¿ã‚’å¤§ããã—ãŸå…‰ç’°å¢ƒæŒ‡æ¨™
                </div>

                <div class="action-btns">
                    <button class="sm-btn btn-back" onclick="goHome()">ğŸ  æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Service Workerç™»éŒ² (æµç”¨OK!) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('SW registered: ', registration.scope);
            }, function(err) {
                console.log('SW failed: ', err);
            });
        });
    }

    // --- å¤‰æ•° ---
    let originalImg = null; 
    let originalData = null; 
    let canvas = document.getElementById('mainCanvas');
    let ctx = canvas.getContext('2d');
    let lensParams = { x: 0.5, y: 0.5, r: 0.4 }; 
    
    const startScreen = document.getElementById('startScreen');
    const analysisScreen = document.getElementById('analysisScreen');
    const circleOverlay = document.getElementById('circleOverlay');
    const fileInput = document.getElementById('fileInput');

    // --- èµ·å‹•ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ---
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => loadImages(ev.target.result);
        reader.readAsDataURL(file);
    });

    function startCamera() {
        fileInput.setAttribute('capture', 'environment');
        fileInput.click();
        setTimeout(() => fileInput.removeAttribute('capture'), 1000);
    }

    function loadImages(src) {
        const img = new Image();
        img.onload = () => {
            originalImg = img;
            startScreen.style.display = 'none';
            analysisScreen.style.display = 'flex';
            drawOriginal();
            switchTab('lens');
            updateOverlayPos();
        };
        img.src = src;
    }

    function goHome() {
        analysisScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        fileInput.value = '';
    }

    // --- æç”»ãƒ»ãƒ¬ãƒ³ã‚ºèª¿æ•´ ---
    function drawOriginal() {
        const container = document.getElementById('canvasContainer');
        const cw = container.clientWidth;
        const ch = container.clientHeight;
        const imgRatio = originalImg.width / originalImg.height;
        const screenRatio = cw / ch;
        
        let drawW, drawH;
        if (imgRatio > screenRatio) {
            drawW = cw; drawH = cw / imgRatio;
        } else {
            drawH = ch; drawW = ch * imgRatio;
        }

        canvas.width = drawW;
        canvas.height = drawH;
        ctx.drawImage(originalImg, 0, 0, drawW, drawH);
        originalData = ctx.getImageData(0,0, drawW, drawH);
    }

    document.getElementById('sizeSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('xSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('ySlider').addEventListener('input', updateOverlayPos);

    function updateOverlayPos() {
        const sSize = parseInt(document.getElementById('sizeSlider').value);
        const sX = parseInt(document.getElementById('xSlider').value);
        const sY = parseInt(document.getElementById('ySlider').value);

        const minSide = Math.min(canvas.width, canvas.height);
        const pxRadius = (minSide / 2) * (sSize / 100) * 1.5;
        const pxX = canvas.width * (sX / 100);
        const pxY = canvas.height * (sY / 100);

        circleOverlay.style.width = (pxRadius * 2) + 'px';
        circleOverlay.style.height = (pxRadius * 2) + 'px';
        
        const rect = canvas.getBoundingClientRect();
        const conRect = document.getElementById('canvasContainer').getBoundingClientRect();
        const finalLeft = (rect.left - conRect.left) + pxX;
        const finalTop = (rect.top - conRect.top) + pxY;

        circleOverlay.style.left = (finalLeft - pxRadius) + 'px';
        circleOverlay.style.top = (finalTop - pxRadius) + 'px';
        circleOverlay.style.display = 'block';

        lensParams = { cx: pxX, cy: pxY, r: pxRadius };
    }

    // --- è§£æå‡¦ç† ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.control-group').forEach(g => g.classList.remove('active'));
        
        if (tabName === 'lens') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tab-lens').classList.add('active');
            circleOverlay.style.display = 'block';
            ctx.putImageData(originalData, 0, 0);
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tab-analysis').classList.add('active');
            circleOverlay.style.display = 'none';
            processImage();
        }
    }

    function processImage() {
        if (!originalData) return;
        
        const thresh = parseInt(document.getElementById('threshSlider').value);
        const w = canvas.width;
        const h = canvas.height;
        
        const src = originalData.data;
        const out = ctx.createImageData(w, h);
        const dst = out.data;
        
        const cx = lensParams.cx;
        const cy = lensParams.cy;
        const rMax = lensParams.r;

        let skyScore = 0;
        let maxScore = 0;
        let skyPix = 0;
        let totalPix = 0;

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                const dx = x - cx;
                const dy = y - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > rMax) {
                    dst[i] = 0; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
                    continue;
                }

                const lum = 0.299*src[i] + 0.587*src[i+1] + 0.114*src[i+2];
                const theta = (dist / rMax) * (Math.PI / 2); 
                const weight = Math.sin(theta) * Math.cos(theta); // é–‹ç©ºåº¦ã®é‡ã¿
                
                maxScore += weight;
                totalPix++;

                if (lum > thresh) {
                    dst[i] = 255; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255; // èµ¤
                    skyScore += weight;
                    skyPix++;
                } else {
                    dst[i] = src[i]; dst[i+1] = src[i+1]; dst[i+2] = src[i+2]; dst[i+3] = 255;
                }
            }
        }
        
        ctx.putImageData(out, 0, 0);

        const svf = (skyScore / maxScore) * 100;
        const open = (skyPix / totalPix) * 100;

        document.getElementById('valSVF').textContent = svf.toFixed(1) + '%';
        document.getElementById('valOpen').textContent = open.toFixed(1) + '%';
    }
</script>
</body>
</html>
