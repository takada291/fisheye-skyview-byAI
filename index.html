<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIé­šçœ¼</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-fish.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f4f8; color: #333; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow-y: auto;
        }
        .app-title { font-size: 1.8rem; color: #2980b9; margin: 20px 0 10px 0; font-weight: bold; }
        
        .settings-area {
            background: #fff; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .setting-row { margin-bottom: 15px; }
        .setting-label { display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50; font-size: 0.9rem; }
        select, input[type="number"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem;
            background: #f9f9f9;
        }

        .mode-btn {
            width: 85%; max-width: 350px; padding: 15px; margin: 5px;
            font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .mode-btn:active { transform: scale(0.95); }
        .btn-camera { background-color: #e67e22; color: white; }
        .btn-file { background-color: #3498db; color: white; }

        /* --- ã‚«ãƒ¡ãƒ©ç”»é¢ --- */
        #cameraContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 90;
            display: none; flex-direction: column;
        }
        .video-wrapper {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        #video { width: 100%; height: 100%; object-fit: contain; }
        
        .north-warning {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; z-index: 15; pointer-events: none;
        }
        .north-badge {
            background: rgba(231, 76, 60, 0.9); color: white;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); border: 2px solid white;
        }

        .level-overlay {
            position: absolute; width: 200px; height: 200px;
            border-radius: 50%; border: 2px dashed rgba(255, 255, 255, 0.5);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .target-circle {
            width: 60px; height: 60px; border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%; z-index: 11; transition: all 0.2s;
        }
        .target-circle.ok {
            border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.3);
            box-shadow: 0 0 15px #2ecc71;
        }
        .bubble {
            position: absolute; width: 30px; height: 30px;
            background-color: #e74c3c; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 12; transition: transform 0.1s linear;
        }
        .sensor-btn {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            z-index: 20; background: rgba(0,0,0,0.6); color: #fff;
            border: 1px solid #fff; padding: 8px 16px; border-radius: 20px; display: none;
        }
        
        .camera-controls {
            height: 120px; background: #222;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .shutter-btn {
            width: 70px; height: 70px; background-color: #fff;
            border-radius: 50%; border: 5px solid #ccc; cursor: pointer;
        }
        .btn-cam-back {
            position: absolute; left: 20px; color: white; cursor: pointer; font-size: 0.9rem;
        }

        /* --- è§£æç”»é¢ --- */
        #analysisScreen {
            display: none; flex-direction: column; height: 100%;
            background-color: #2c3e50; z-index: 80;
        }
        .canvas-container {
            flex: 1; position: relative; background: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        
        #canvasWrapper {
            position: relative;
        }
        
        canvas { display: block; }
        #sunCanvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #circleOverlay {
            position: absolute; border: 2px solid rgba(231, 76, 60, 0.8);
            border-radius: 50%; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none; display: none; top: 0; left: 0;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .controls-panel {
            background: #fff; color: #333;
            padding: 15px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            max-height: 50vh; overflow-y: auto;
        }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
        .tab {
            flex: 1; padding: 8px; text-align: center; cursor: pointer;
            font-weight: bold; color: #7f8c8d; border-bottom: 3px solid transparent;
        }
        .tab.active { color: #2980b9; border-bottom-color: #2980b9; }

        .control-group { display: none; }
        .control-group.active { display: block; }

        .slider-row { display: flex; align-items: center; margin-bottom: 8px; }
        .slider-label { width: 60px; font-size: 0.8rem; font-weight: bold; }
        input[type=range] { flex: 1; }

        /* â–¼â–¼â–¼ çµæœè¡¨ç¤ºï¼ˆçœã‚¹ãƒšãƒ¼ã‚¹åŒ–ï¼‰ â–¼â–¼â–¼ */
        .result-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; /* éš™é–“ã‚’è©°ã‚ã‚‹ */
            background: #ecf0f1; padding: 8px; border-radius: 10px; margin-top: 5px;
        }
        .res-card {
            background: #fff; padding: 5px; border-radius: 8px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .res-card.full-width { grid-column: 1 / -1; background: #e8f6f3; border: 1px solid #2ecc71; }
        
        /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—å°ã•ãã—ã¦ç”»é¢å†…ã«åã‚ã‚‹ */
        .res-val { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        .res-val.main { font-size: 1.6rem; color: #27ae60; }
        .res-label { font-size: 0.7rem; color: #7f8c8d; margin-top: 3px; }

        .action-btns { display: flex; justify-content: space-between; margin-top: 15px; }
        .sm-btn { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-back { background: #95a5a6; color: white; }
        .btn-recalc { background: #27ae60; color: white; }

        /* â–¼â–¼â–¼ GPSã‚¨ãƒªã‚¢ â–¼â–¼â–¼ */
        .gps-section {
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .gps-btn {
            background-color: #3498db;
            color: white; border: none;
            padding: 8px; border-radius: 8px;
            font-size: 0.9rem; font-weight: bold;
            cursor: pointer; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .gps-result {
            margin-top: 5px; font-family: monospace; font-size: 0.8rem;
            color: #2c3e50; background: #ecf0f1; padding: 8px;
            border-radius: 5px; display: none; word-break: break-all;
        }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="app-title">ğŸŸ AIé­šçœ¼ v3.3</div>
        <div class="settings-area">
            <div class="setting-row">
                <label class="setting-label">ğŸ“ è§£æåœ°ç‚¹ï¼ˆéƒ½é“åºœçœŒï¼‰</label>
                <select id="prefSelect" onchange="updateLat()"></select>
            </div>
            <div class="setting-row">
                <label class="setting-label">ç·¯åº¦ (æ‰‹å‹•å…¥åŠ›å¯)</label>
                <input type="number" id="latInput" step="0.1" value="36.0">
            </div>
        </div>
        <button class="mode-btn btn-camera" onclick="startCameraMode()"><span>ğŸ“·â¬†ï¸</span> æ’®å½±ï¼ˆåŒ—ã‚’ä¸Šã«ï¼ï¼‰</button>
        <button class="mode-btn btn-file" onclick="document.getElementById('fileInput').click()"><span>ğŸ“‚</span> å†™çœŸã‚’é¸æŠ</button>
    </div>
    <input type="file" id="fileInput" accept="image/*">

    <div id="cameraContainer">
        <div class="video-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div class="north-warning"><span class="north-badge">â¬†ï¸ ã‚¹ãƒãƒ›ã®ä¸Šã‚’ã€ŒåŒ—ã€ã¸ï¼</span></div>
            <button id="sensorBtn" class="sensor-btn" onclick="requestSensorPermission()">ğŸ“¡ æ°´æº–å™¨ON</button>
            <div class="level-overlay">
                <div class="target-circle" id="targetCircle"></div>
                <div class="bubble" id="bubble"></div>
            </div>
        </div>
        <div class="camera-controls">
            <div class="btn-cam-back" onclick="closeCameraMode()">ğŸ  æˆ»ã‚‹</div>
            <button class="shutter-btn" id="shutterBtn"></button>
        </div>
    </div>

    <div id="analysisScreen">
        <div class="canvas-container" id="canvasContainer">
            <div id="canvasWrapper">
                <canvas id="mainCanvas"></canvas>
                <canvas id="sunCanvas"></canvas> 
                <div id="circleOverlay"></div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('lens')">â‘  ãƒ¬ãƒ³ã‚ºèª¿æ•´</div>
                <div class="tab" onclick="switchTab('analysis')">â‘¡ è§£æãƒ»æ—¥ç…§</div>
            </div>

            <div id="tab-lens" class="control-group active">
                <p style="font-size:0.8rem; margin-bottom:10px; text-align:center;">èµ¤æ ã‚’å†™çœŸã®å††å‘¨ã«åˆã‚ã›ã¦ãã ã•ã„</p>
                <div class="slider-row"><span class="slider-label">ã‚µã‚¤ã‚º</span><input type="range" id="sizeSlider" min="10" max="100" value="80"></div>
                <div class="slider-row"><span class="slider-label">å·¦å³ X</span><input type="range" id="xSlider" min="0" max="100" value="50"></div>
                <div class="slider-row"><span class="slider-label">ä¸Šä¸‹ Y</span><input type="range" id="ySlider" min="0" max="100" value="50"></div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="sm-btn btn-recalc" onclick="switchTab('analysis')">æ¬¡ã¸ï¼ˆè§£æå®Ÿè¡Œï¼‰</button>
                </div>
            </div>

            <div id="tab-analysis" class="control-group">
                <div class="slider-row">
                    <span class="slider-label">2å€¤åŒ–</span>
                    <input type="range" id="threshSlider" min="0" max="255" value="180" oninput="processImage()">
                </div>
                
                <div class="result-grid">
                    <div class="res-card full-width">
                        <div class="res-val main" id="valRI">-%</div>
                        <div class="res-label">ç›¸å¯¾ç…§åº¦ (å¹´å¹³å‡æ¨å®š)</div>
                    </div>
                    <div class="res-card"><div class="res-val" id="valSummer">-h</div><div class="res-label">å¤è‡³ã®æ—¥ç…§</div></div>
                    <div class="res-card"><div class="res-val" id="valWinter">-h</div><div class="res-label">å†¬è‡³ã®æ—¥ç…§</div></div>
                    <div class="res-card"><div class="res-val" id="valSVF">-%</div><div class="res-label">é–‹ç©ºåº¦ (SVF)</div></div>
                </div>
                
                <div style="text-align:center; font-size:0.7rem; color:#7f8c8d; margin-top:3px;">
                    <span style="color:gold;">â—</span>å¤è‡³ / <span style="color:orange;">â—</span>æ˜¥ç§‹ / <span style="color:cyan;">â—</span>å†¬è‡³
                </div>

                <div class="gps-section">
                    <button class="gps-btn" onclick="getLocation()">ğŸ“ ç·¯åº¦çµŒåº¦ã‚’å–å¾—</button>
                    <div id="gpsResult" class="gps-result"></div>
                </div>
                <div class="action-btns"><button class="sm-btn btn-back" onclick="goHome()">ğŸ  æˆ»ã‚‹</button></div>
            </div>
        </div>
    </div>

<script>
    const prefectures = [
        { name: "åŒ—æµ·é“", lat: 43.06 }, { name: "é’æ£®çœŒ", lat: 40.82 }, { name: "å²©æ‰‹çœŒ", lat: 39.70 },
        { name: "å®®åŸçœŒ", lat: 38.27 }, { name: "ç§‹ç”°çœŒ", lat: 39.72 }, { name: "å±±å½¢çœŒ", lat: 38.24 },
        { name: "ç¦å³¶çœŒ", lat: 37.75 }, { name: "èŒ¨åŸçœŒ", lat: 36.34 }, { name: "æ ƒæœ¨çœŒ", lat: 36.56 },
        { name: "ç¾¤é¦¬çœŒ", lat: 36.39 }, { name: "åŸ¼ç‰çœŒ", lat: 35.85 }, { name: "åƒè‘‰çœŒ", lat: 35.60 },
        { name: "æ±äº¬éƒ½", lat: 35.69 }, { name: "ç¥å¥ˆå·", lat: 35.45 }, { name: "æ–°æ½ŸçœŒ", lat: 37.90 },
        { name: "å¯Œå±±çœŒ", lat: 36.70 }, { name: "çŸ³å·çœŒ", lat: 36.59 }, { name: "ç¦äº•çœŒ", lat: 36.06 },
        { name: "å±±æ¢¨çœŒ", lat: 35.66 }, { name: "é•·é‡çœŒ", lat: 36.65 }, { name: "å²é˜œçœŒ", lat: 35.39 },
        { name: "é™å²¡çœŒ", lat: 34.97 }, { name: "æ„›çŸ¥çœŒ", lat: 35.18 }, { name: "ä¸‰é‡çœŒ", lat: 34.73 },
        { name: "æ»‹è³€çœŒ", lat: 35.00 }, { name: "äº¬éƒ½åºœ", lat: 35.02 }, { name: "å¤§é˜ªåºœ", lat: 34.68 },
        { name: "å…µåº«çœŒ", lat: 34.69 }, { name: "å¥ˆè‰¯çœŒ", lat: 34.68 }, { name: "å’Œæ­Œå±±", lat: 34.22 },
        { name: "é³¥å–çœŒ", lat: 35.50 }, { name: "å³¶æ ¹çœŒ", lat: 35.47 }, { name: "å²¡å±±çœŒ", lat: 34.66 },
        { name: "åºƒå³¶çœŒ", lat: 34.39 }, { name: "å±±å£çœŒ", lat: 34.18 }, { name: "å¾³å³¶çœŒ", lat: 34.06 },
        { name: "é¦™å·çœŒ", lat: 34.34 }, { name: "æ„›åª›çœŒ", lat: 33.84 }, { name: "é«˜çŸ¥çœŒ", lat: 33.55 },
        { name: "ç¦å²¡çœŒ", lat: 33.60 }, { name: "ä½è³€çœŒ", lat: 33.24 }, { name: "é•·å´çœŒ", lat: 32.74 },
        { name: "ç†Šæœ¬çœŒ", lat: 32.78 }, { name: "å¤§åˆ†çœŒ", lat: 33.23 }, { name: "å®®å´çœŒ", lat: 31.91 },
        { name: "é¹¿å…å³¶", lat: 31.56 }, { name: "æ²–ç¸„çœŒ", lat: 26.21 }
    ];

    const prefSelect = document.getElementById('prefSelect');
    const latInput = document.getElementById('latInput');
    prefectures.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.lat;
        opt.textContent = p.name;
        if(p.name === "ç¦äº•çœŒ") opt.selected = true;
        prefSelect.appendChild(opt);
    });
    latInput.value = prefSelect.value;
    function updateLat() { latInput.value = prefSelect.value; }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    let originalImg = null; 
    let originalData = null; 
    let canvas = document.getElementById('mainCanvas');
    let ctx = canvas.getContext('2d');
    let sunCanvas = document.getElementById('sunCanvas');
    let sunCtx = sunCanvas.getContext('2d');
    let canvasWrapper = document.getElementById('canvasWrapper');
    let gpsResult = document.getElementById('gpsResult'); // GPSç”¨
    
    let lensParams = { x: 0.5, y: 0.5, r: 0.4 }; 
    let currentStream = null;
    let isCameraRunning = false;
    
    const startScreen = document.getElementById('startScreen');
    const cameraContainer = document.getElementById('cameraContainer');
    const analysisScreen = document.getElementById('analysisScreen');
    const circleOverlay = document.getElementById('circleOverlay');
    const fileInput = document.getElementById('fileInput');
    const video = document.getElementById('video');
    const bubble = document.getElementById('bubble');
    const targetCircle = document.getElementById('targetCircle');
    const sensorBtn = document.getElementById('sensorBtn');

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => loadImages(ev.target.result);
        reader.readAsDataURL(file);
    });

    function loadImages(src) {
        const img = new Image();
        img.onload = () => {
            originalImg = img;
            startScreen.style.display = 'none';
            cameraContainer.style.display = 'none';
            analysisScreen.style.display = 'flex';
            drawOriginal();
            switchTab('lens');
            updateOverlayPos();
        };
        img.src = src;
    }

    async function startCameraMode() {
        startScreen.style.display = 'none';
        cameraContainer.style.display = 'flex';
        try {
            const constraints = { 
                video: { facingMode: 'environment', width: { ideal: 2160 }, height: { ideal: 2160 } }, 
                audio: false 
            };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            isCameraRunning = true;
            checkSensorPermission();
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message);
            closeCameraMode();
        }
    }

    function closeCameraMode() {
        if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; }
        isCameraRunning = false;
        cameraContainer.style.display = 'none';
        startScreen.style.display = 'flex';
    }

    document.getElementById('shutterBtn').addEventListener('click', () => {
        const w = video.videoWidth;
        const h = video.videoHeight;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w; tempCanvas.height = h;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(video, 0, 0, w, h);
        loadImages(tempCanvas.toDataURL('image/jpeg'));
        if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; }
        isCameraRunning = false;
    });

    function checkSensorPermission() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            sensorBtn.style.display = 'block';
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }
    function requestSensorPermission() {
        DeviceOrientationEvent.requestPermission().then(r => {
            if (r === 'granted') { sensorBtn.style.display = 'none'; window.addEventListener('deviceorientation', handleOrientation); }
        });
    }
    function handleOrientation(event) {
        if (!isCameraRunning) return;
        let x = event.gamma; let y = event.beta;
        if (Math.abs(y) > 90) { if (y > 0) y = 180 - y; else y = -180 - y; }
        let moveX = x * 1.5; let moveY = y * 1.5;
        const maxDist = 80;
        const dist = Math.sqrt(moveX*moveX + moveY*moveY);
        if (dist > maxDist) { moveX = (moveX/dist)*maxDist; moveY = (moveY/dist)*maxDist; }
        bubble.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        if (Math.abs(x) < 10 && Math.abs(y) < 10) targetCircle.classList.add('ok');
        else targetCircle.classList.remove('ok');
    }

    function goHome() {
        analysisScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        fileInput.value = '';
        gpsResult.style.display = 'none';
        gpsResult.textContent = '';
    }

    function drawOriginal() {
        const container = document.getElementById('canvasContainer');
        const cw = container.clientWidth;
        const ch = container.clientHeight;
        const imgRatio = originalImg.width / originalImg.height;
        const screenRatio = cw / ch;
        let drawW, drawH;
        if (imgRatio > screenRatio) { drawW = cw; drawH = cw / imgRatio; }
        else { drawH = ch; drawW = ch * imgRatio; }

        canvasWrapper.style.width = drawW + 'px';
        canvasWrapper.style.height = drawH + 'px';

        canvas.width = drawW; canvas.height = drawH;
        sunCanvas.width = drawW; sunCanvas.height = drawH;

        ctx.drawImage(originalImg, 0, 0, drawW, drawH);
        originalData = ctx.getImageData(0,0, drawW, drawH);
    }

    document.getElementById('sizeSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('xSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('ySlider').addEventListener('input', updateOverlayPos);

    function updateOverlayPos() {
        const sSize = parseInt(document.getElementById('sizeSlider').value);
        const sX = parseInt(document.getElementById('xSlider').value);
        const sY = parseInt(document.getElementById('ySlider').value);
        const minSide = Math.min(canvas.width, canvas.height);
        const pxRadius = (minSide / 2) * (sSize / 100) * 1.5;
        const pxX = canvas.width * (sX / 100);
        const pxY = canvas.height * (sY / 100);

        circleOverlay.style.width = (pxRadius * 2) + 'px';
        circleOverlay.style.height = (pxRadius * 2) + 'px';
        
        circleOverlay.style.left = (pxX - pxRadius) + 'px';
        circleOverlay.style.top = (pxY - pxRadius) + 'px';
        circleOverlay.style.display = 'block';

        lensParams = { cx: pxX, cy: pxY, r: pxRadius };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.control-group').forEach(g => g.classList.remove('active'));
        
        if (tabName === 'lens') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tab-lens').classList.add('active');
            circleOverlay.style.display = 'block';
            sunCtx.clearRect(0, 0, sunCanvas.width, sunCanvas.height);
            ctx.putImageData(originalData, 0, 0);
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tab-analysis').classList.add('active');
            circleOverlay.style.display = 'none';
            processImage();
        }
    }

    function processImage() {
        if (!originalData) return;
        
        const thresh = parseInt(document.getElementById('threshSlider').value);
        const w = canvas.width;
        const h = canvas.height;
        const src = originalData.data;
        const out = ctx.createImageData(w, h);
        const dst = out.data;
        
        const cx = lensParams.cx;
        const cy = lensParams.cy;
        const rMax = lensParams.r;

        let skyScore = 0;
        let maxScore = 0;
        
        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                const dx = x - cx; const dy = y - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > rMax) {
                    dst[i] = 0; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
                    continue;
                }

                const lum = 0.299*src[i] + 0.587*src[i+1] + 0.114*src[i+2];
                const theta = (dist / rMax) * (Math.PI / 2);
                const weight = Math.sin(theta) * Math.cos(theta);
                maxScore += weight;

                if (lum > thresh) {
                    dst[i] = 255; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
                    skyScore += weight;
                } else {
                    dst[i] = src[i]; dst[i+1] = src[i+1]; dst[i+2] = src[i+2]; dst[i+3] = 255;
                }
            }
        }
        ctx.putImageData(out, 0, 0);
        const svf = (skyScore / maxScore) * 100;
        document.getElementById('valSVF').textContent = svf.toFixed(1) + '%';

        const lat = parseFloat(document.getElementById('latInput').value);
        const declinations = [-23.4, 0, 23.4];
        const colors = ['cyan', 'orange', 'gold'];
        const results = [];

        sunCtx.clearRect(0, 0, sunCanvas.width, sunCanvas.height);
        
        declinations.forEach((dec, idx) => {
            let total = 0;
            let sky = 0;
            let weightedSky = 0;
            let weightedTotal = 0;
            
            sunCtx.beginPath();
            sunCtx.strokeStyle = colors[idx];
            sunCtx.lineWidth = 3;
            let first = true;

            for (let t = 5; t <= 19; t += 0.25) {
                const pos = getSunPos(lat, dec, t);
                if (pos.alt <= 0) continue; 

                const r = (90 - pos.alt) / 90 * rMax; 
                const angle = Math.PI / 2 - (pos.azi * Math.PI / 180);
                
                const px = cx + r * Math.cos(angle);
                const py = cy + r * Math.sin(angle);

                if (first) { sunCtx.moveTo(px, py); first = false; }
                else { sunCtx.lineTo(px, py); }

                if (px >= 0 && px < w && py >= 0 && py < h) {
                    const pixIdx = (Math.floor(py) * w + Math.floor(px)) * 4;
                    const isSky = (dst[pixIdx] === 255 && dst[pixIdx+1] === 0);
                    const intensity = Math.sin(pos.alt * Math.PI / 180);
                    total++;
                    weightedTotal += intensity;
                    if (isSky) { sky++; weightedSky += intensity; }
                }
            }
            sunCtx.stroke();
            
            const sunHours = sky * 0.25;
            const relativeI = (weightedTotal > 0) ? (weightedSky / weightedTotal) : 0;
            results.push({ hours: sunHours, ri: relativeI });
        });

        document.getElementById('valWinter').textContent = results[0].hours.toFixed(1) + 'h';
        document.getElementById('valSummer').textContent = results[2].hours.toFixed(1) + 'h';
        const avgRI = (results[0].ri + results[1].ri * 2 + results[2].ri) / 4 * 100;
        document.getElementById('valRI').textContent = avgRI.toFixed(1) + '%';
    }

    function getSunPos(lat, dec, t) {
        const latRad = lat * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const hRad = (t - 12) * 15 * Math.PI / 180;
        const sinAlt = Math.sin(latRad) * Math.sin(decRad) + Math.cos(latRad) * Math.cos(decRad) * Math.cos(hRad);
        const altRad = Math.asin(sinAlt);
        const cosAlt = Math.cos(altRad);
        let sinAzi = Math.cos(decRad) * Math.sin(hRad) / cosAlt;
        if (sinAzi > 1) sinAzi = 1; if (sinAzi < -1) sinAzi = -1;
        let aziRad = Math.asin(sinAzi);
        const cosAzi = (sinAlt * Math.sin(latRad) - Math.sin(decRad)) / (cosAlt * Math.cos(latRad));
        if (cosAzi < 0) { aziRad = Math.PI - aziRad; if (hRad < 0) aziRad = -Math.PI - Math.asin(sinAzi); }
        return { alt: altRad * 180 / Math.PI, azi: aziRad * 180 / Math.PI };
    }

    // --- GPSå–å¾— ---
    function getLocation() {
        gpsResult.style.display = 'block';
        gpsResult.innerHTML = "ğŸ“¡ å–å¾—ä¸­...";

        if (!navigator.geolocation) {
            gpsResult.textContent = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                gpsResult.innerHTML = `ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}`;
            },
            (error) => {
                let errorMsg = "å–å¾—å¤±æ•—";
                switch(error.code) {
                    case 1: errorMsg = "è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"; break;
                    case 2: errorMsg = "åˆ©ç”¨ã§ãã¾ã›ã‚“"; break;
                    case 3: errorMsg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"; break;
                }
                gpsResult.textContent = errorMsg;
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }
</script>
</body>
</html>
