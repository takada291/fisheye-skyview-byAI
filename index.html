<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIé­šçœ¼</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-fish.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        body {
            font-family: sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- 1. ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f4f8; color: #333; z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .app-title { font-size: 2rem; color: #2980b9; margin-bottom: 20px; font-weight: bold; }
        .app-desc { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 40px; text-align: center; }
        .mode-btn {
            width: 250px; padding: 20px; margin: 10px;
            font-size: 1.2rem; font-weight: bold;
            border: none; border-radius: 15px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .mode-btn:active { transform: scale(0.95); }
        .btn-camera { background-color: #2980b9; color: white; }
        .btn-file { background-color: #8e44ad; color: white; }

        /* --- 2. ã‚«ãƒ¡ãƒ©æ’®å½±ç”»é¢ï¼ˆæ°´æº–å™¨ä»˜ãï¼‰ --- */
        #cameraContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 90;
            display: none; flex-direction: column;
        }
        .video-wrapper {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æ°´æº–å™¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .level-overlay {
            position: absolute;
            width: 200px; height: 200px;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .crosshair { position: absolute; width: 100%; height: 100%; }
        .crosshair::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.5); }
        .crosshair::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.5); }
        
        .target-circle {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%; z-index: 11; transition: all 0.2s;
        }
        .target-circle.ok {
            border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.3);
            box-shadow: 0 0 15px #2ecc71;
        }
        .bubble {
            position: absolute; width: 30px; height: 30px;
            background-color: #e74c3c; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 12; transition: transform 0.1s linear;
        }
        .sensor-btn {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 20; background: rgba(0,0,0,0.6); color: #fff;
            border: 1px solid #fff; padding: 8px 16px; border-radius: 20px; display: none;
        }
        
        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .camera-controls {
            height: 120px; background: #222;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .shutter-btn {
            width: 70px; height: 70px; background-color: #fff;
            border-radius: 50%; border: 5px solid #ccc; cursor: pointer;
        }
        .btn-cam-back {
            position: absolute; left: 20px; color: white; cursor: pointer; font-size: 0.9rem;
        }


        /* --- 3. è§£æãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        #analysisScreen {
            display: none; flex-direction: column; height: 100%;
            background-color: #2c3e50; z-index: 80;
        }
        
        /* ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .canvas-container {
            flex: 1; position: relative;
            background: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { max-width: 100%; max-height: 100%; }

        /* å††åˆã‚ã›ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #circleOverlay {
            position: absolute;
            border: 2px solid rgba(231, 76, 60, 0.8); /* èµ¤æ  */
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* æ å¤–ã‚’æš—ã */
            pointer-events: none;
            display: none; /* èª¿æ•´ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º */
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .controls-panel {
            background: #fff; color: #333;
            padding: 15px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            max-height: 50vh; overflow-y: auto;
        }

        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            font-weight: bold; color: #7f8c8d; border-bottom: 3px solid transparent;
        }
        .tab.active { color: #2980b9; border-bottom-color: #2980b9; }

        .control-group { display: none; }
        .control-group.active { display: block; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .slider-row { display: flex; align-items: center; margin-bottom: 10px; }
        .slider-label { width: 70px; font-size: 0.8rem; font-weight: bold; }
        input[type=range] { flex: 1; }

        /* çµæœè¡¨ç¤º */
        .result-box {
            background: #ecf0f1; padding: 15px; border-radius: 10px;
            margin-top: 15px; display: flex; justify-content: space-around;
        }
        .res-item { text-align: center; }
        .res-val { font-size: 1.8rem; font-weight: bold; color: #2980b9; }
        .res-label { font-size: 0.8rem; color: #7f8c8d; }

        .action-btns { display: flex; justify-content: space-between; margin-top: 15px; }
        .sm-btn { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-back { background: #95a5a6; color: white; }
        .btn-recalc { background: #27ae60; color: white; }

        /* éš ã—è¦ç´  */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="app-title">ğŸŸ AIé­šçœ¼ v2.0</div>
        <div class="app-desc">æ°´æº–å™¨æ­è¼‰ãƒ»å…¨å¤©ç©ºè§£æãƒ„ãƒ¼ãƒ«</div>
        
        <button class="mode-btn btn-camera" onclick="startCameraMode()">
            <span>ğŸ“·</span> ã‚«ãƒ¡ãƒ©ã§æ’®å½±
        </button>
        <button class="mode-btn btn-file" onclick="document.getElementById('fileInput').click()">
            <span>ğŸ“‚</span> å†™çœŸã‚’é¸æŠ
        </button>
    </div>
    <input type="file" id="fileInput" accept="image/*">

    <div id="cameraContainer">
        <div class="video-wrapper">
            <video id="video" autoplay playsinline muted></video>
            
            <button id="sensorBtn" class="sensor-btn" onclick="requestSensorPermission()">ğŸ“¡ æ°´æº–å™¨ON</button>
            
            <div class="level-overlay">
                <div class="crosshair"></div>
                <div class="target-circle" id="targetCircle"></div>
                <div class="bubble" id="bubble"></div>
            </div>
        </div>
        <div class="camera-controls">
            <div class="btn-cam-back" onclick="closeCameraMode()">ğŸ  æˆ»ã‚‹</div>
            <button class="shutter-btn" id="shutterBtn"></button>
        </div>
    </div>

    <div id="analysisScreen">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div id="circleOverlay"></div>
        </div>

        <div class="controls-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('lens')">â‘  ãƒ¬ãƒ³ã‚ºåˆã‚ã›</div>
                <div class="tab" onclick="switchTab('analysis')">â‘¡ è§£æãƒ»çµæœ</div>
            </div>

            <div id="tab-lens" class="control-group active">
                <p style="font-size:0.8rem; margin-bottom:10px;">èµ¤æ ã‚’é­šçœ¼ãƒ¬ãƒ³ã‚ºã®ä¸¸ã„å†™çœŸã«åˆã‚ã›ã¦ãã ã•ã„</p>
                <div class="slider-row">
                    <span class="slider-label">ã‚µã‚¤ã‚º</span>
                    <input type="range" id="sizeSlider" min="10" max="100" value="80">
                </div>
                <div class="slider-row">
                    <span class="slider-label">å·¦å³ X</span>
                    <input type="range" id="xSlider" min="0" max="100" value="50">
                </div>
                <div class="slider-row">
                    <span class="slider-label">ä¸Šä¸‹ Y</span>
                    <input type="range" id="ySlider" min="0" max="100" value="50">
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="sm-btn btn-recalc" onclick="switchTab('analysis')">æ¬¡ã¸ï¼ˆè§£æï¼‰</button>
                </div>
            </div>

            <div id="tab-analysis" class="control-group">
                <div class="slider-row">
                    <span class="slider-label">æ˜ã‚‹ã•</span>
                    <input type="range" id="threshSlider" min="0" max="255" value="180" oninput="processImage()">
                </div>
                <div style="font-size:0.7rem; color:#e74c3c; text-align:right;">â€»èµ¤è‰²ï¼ç©º</div>

                <div class="result-box">
                    <div class="res-item">
                        <div class="res-label">é–‹ç©ºåº¦ (SVF)</div>
                        <div class="res-val" id="valSVF">-</div>
                    </div>
                    <div class="res-item">
                        <div class="res-label">å˜ç´”ç©ºéš™ç‡</div>
                        <div class="res-val" id="valOpen">-</div>
                    </div>
                </div>
                
                <div class="action-btns">
                    <button class="sm-btn btn-back" onclick="goHome()">ğŸ  æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Service Worker ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    // --- å¤‰æ•° ---
    let originalImg = null; 
    let originalData = null; 
    let canvas = document.getElementById('mainCanvas');
    let ctx = canvas.getContext('2d');
    let lensParams = { x: 0.5, y: 0.5, r: 0.4 }; 
    let currentStream = null;
    let isCameraRunning = false;
    
    // UIå‚ç…§
    const startScreen = document.getElementById('startScreen');
    const cameraContainer = document.getElementById('cameraContainer');
    const analysisScreen = document.getElementById('analysisScreen');
    const circleOverlay = document.getElementById('circleOverlay');
    const fileInput = document.getElementById('fileInput');
    const video = document.getElementById('video');
    const bubble = document.getElementById('bubble');
    const targetCircle = document.getElementById('targetCircle');
    const sensorBtn = document.getElementById('sensorBtn');

    // ==========================================
    // 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ‰å‡¦ç†
    // ==========================================
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => loadImages(ev.target.result);
        reader.readAsDataURL(file);
    });

    function loadImages(src) {
        const img = new Image();
        img.onload = () => {
            originalImg = img;
            startScreen.style.display = 'none';
            cameraContainer.style.display = 'none';
            analysisScreen.style.display = 'flex';
            drawOriginal();
            switchTab('lens');
            updateOverlayPos();
        };
        img.src = src;
    }

    // ==========================================
    // 2. ã‚«ãƒ¡ãƒ©ãƒ»æ°´æº–å™¨ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
    // ==========================================
    
    async function startCameraMode() {
        startScreen.style.display = 'none';
        cameraContainer.style.display = 'flex';
        
        try {
            const constraints = {
                video: { facingMode: 'environment', width: {ideal: 1920}, height: {ideal: 1080} },
                audio: false
            };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            isCameraRunning = true;
            checkSensorPermission();
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message);
            closeCameraMode();
        }
    }

    function closeCameraMode() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        isCameraRunning = false;
        cameraContainer.style.display = 'none';
        startScreen.style.display = 'flex';
    }

    // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³
    document.getElementById('shutterBtn').addEventListener('click', () => {
        // ãƒ“ãƒ‡ã‚ªã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const w = video.videoWidth;
        const h = video.videoHeight;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = h;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(video, 0, 0, w, h);
        
        // è§£æç”»é¢ã¸ç§»è¡Œ
        loadImages(tempCanvas.toDataURL('image/jpeg'));
        
        // ã‚«ãƒ¡ãƒ©ã¯åœæ­¢
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        isCameraRunning = false;
    });

    // --- æ°´æº–å™¨ãƒ­ã‚¸ãƒƒã‚¯ (AIæ—å† v4.0ç›¸å½“) ---
    function checkSensorPermission() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            sensorBtn.style.display = 'block';
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }
    function requestSensorPermission() {
        DeviceOrientationEvent.requestPermission().then(r => {
            if (r === 'granted') {
                sensorBtn.style.display = 'none';
                window.addEventListener('deviceorientation', handleOrientation);
            }
        });
    }

    function handleOrientation(event) {
        if (!isCameraRunning) return;
        let x = event.gamma; 
        let y = event.beta;

        // è£è¿”ã—(ç©ºæ’®å½±)å¯¾å¿œ
        if (Math.abs(y) > 90) {
            if (y > 0) y = 180 - y;
            else y = -180 - y;
        }

        let moveX = x * 1.5;
        let moveY = y * 1.5;
        const maxDist = 80;
        const dist = Math.sqrt(moveX*moveX + moveY*moveY);
        if (dist > maxDist) {
            moveX = (moveX / dist) * maxDist;
            moveY = (moveY / dist) * maxDist;
        }

        bubble.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

        const threshold = 10;
        if (Math.abs(x) < threshold && Math.abs(y) < threshold) {
            targetCircle.classList.add('ok');
        } else {
            targetCircle.classList.remove('ok');
        }
    }


    // ==========================================
    // 3. å…±é€šãƒ»è§£æå‡¦ç†
    // ==========================================

    function goHome() {
        analysisScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        fileInput.value = '';
    }

    function drawOriginal() {
        const container = document.getElementById('canvasContainer');
        const cw = container.clientWidth;
        const ch = container.clientHeight;
        const imgRatio = originalImg.width / originalImg.height;
        const screenRatio = cw / ch;
        
        let drawW, drawH;
        if (imgRatio > screenRatio) {
            drawW = cw; drawH = cw / imgRatio;
        } else {
            drawH = ch; drawW = ch * imgRatio;
        }

        canvas.width = drawW;
        canvas.height = drawH;
        ctx.drawImage(originalImg, 0, 0, drawW, drawH);
        originalData = ctx.getImageData(0,0, drawW, drawH);
    }

    document.getElementById('sizeSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('xSlider').addEventListener('input', updateOverlayPos);
    document.getElementById('ySlider').addEventListener('input', updateOverlayPos);

    function updateOverlayPos() {
        const sSize = parseInt(document.getElementById('sizeSlider').value);
        const sX = parseInt(document.getElementById('xSlider').value);
        const sY = parseInt(document.getElementById('ySlider').value);

        const minSide = Math.min(canvas.width, canvas.height);
        const pxRadius = (minSide / 2) * (sSize / 100) * 1.5;
        const pxX = canvas.width * (sX / 100);
        const pxY = canvas.height * (sY / 100);

        circleOverlay.style.width = (pxRadius * 2) + 'px';
        circleOverlay.style.height = (pxRadius * 2) + 'px';
        
        const rect = canvas.getBoundingClientRect();
        const conRect = document.getElementById('canvasContainer').getBoundingClientRect();
        
        // ä¸­å¤®åˆã‚ã›è£œæ­£
        const finalLeft = (rect.left - conRect.left) + pxX;
        const finalTop = (rect.top - conRect.top) + pxY;

        circleOverlay.style.left = (finalLeft - pxRadius) + 'px';
        circleOverlay.style.top = (finalTop - pxRadius) + 'px';
        circleOverlay.style.display = 'block';

        lensParams = { cx: pxX, cy: pxY, r: pxRadius };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.control-group').forEach(g => g.classList.remove('active'));
        
        if (tabName === 'lens') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tab-lens').classList.add('active');
            circleOverlay.style.display = 'block';
            ctx.putImageData(originalData, 0, 0);
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tab-analysis').classList.add('active');
            circleOverlay.style.display = 'none';
            processImage();
        }
    }

    function processImage() {
        if (!originalData) return;
        
        const thresh = parseInt(document.getElementById('threshSlider').value);
        const w = canvas.width;
        const h = canvas.height;
        const src = originalData.data;
        const out = ctx.createImageData(w, h);
        const dst = out.data;
        
        const cx = lensParams.cx;
        const cy = lensParams.cy;
        const rMax = lensParams.r;

        let skyScore = 0;
        let maxScore = 0;
        let skyPix = 0;
        let totalPix = 0;

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                const dx = x - cx;
                const dy = y - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > rMax) {
                    dst[i] = 0; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
                    continue;
                }

                const lum = 0.299*src[i] + 0.587*src[i+1] + 0.114*src[i+2];
                const theta = (dist / rMax) * (Math.PI / 2);
                const weight = Math.sin(theta) * Math.cos(theta);
                
                maxScore += weight;
                totalPix++;

                if (lum > thresh) {
                    dst[i] = 255; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
                    skyScore += weight;
                    skyPix++;
                } else {
                    dst[i] = src[i]; dst[i+1] = src[i+1]; dst[i+2] = src[i+2]; dst[i+3] = 255;
                }
            }
        }
        ctx.putImageData(out, 0, 0);

        const svf = (skyScore / maxScore) * 100;
        const open = (skyPix / totalPix) * 100;

        document.getElementById('valSVF').textContent = svf.toFixed(1) + '%';
        document.getElementById('valOpen').textContent = open.toFixed(1) + '%';
    }
</script>
</body>
</html>
